<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åŒæ­¥æµç¨‹</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>ğŸ”„ æµ‹è¯•åŒæ­¥æµç¨‹</h1>
    
    <div class="test-section">
        <h2>1. æ£€æŸ¥å½“å‰çŠ¶æ€</h2>
        <button onclick="checkCurrentState()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <div id="currentStateResult"></div>
    </div>

    <div class="test-section">
        <h2>2. æ·»åŠ æµ‹è¯•é£æ ¼</h2>
        <input type="text" id="testGenreName" placeholder="è¾“å…¥æµ‹è¯•é£æ ¼åç§°" value="æµ‹è¯•åŒæ­¥é£æ ¼" />
        <button onclick="addTestGenre()">æ·»åŠ æµ‹è¯•é£æ ¼</button>
        <div id="addGenreResult"></div>
    </div>

    <div class="test-section">
        <h2>3. æµ‹è¯•æœåŠ¡å™¨åŒæ­¥</h2>
        <button onclick="testServerSync()">æµ‹è¯•æœåŠ¡å™¨åŒæ­¥</button>
        <div id="syncResult"></div>
    </div>

    <div class="test-section">
        <h2>4. éªŒè¯æœåŠ¡å™¨æ•°æ®</h2>
        <button onclick="verifyServerData()">éªŒè¯æœåŠ¡å™¨æ•°æ®</button>
        <div id="verifyResult"></div>
    </div>

    <div class="test-section">
        <h2>5. æµ‹è¯•ä¸»é¡µé¢åˆ·æ–°</h2>
        <button onclick="testMainPageRefresh()">æµ‹è¯•ä¸»é¡µé¢åˆ·æ–°</button>
        <div id="refreshResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸš€ å®Œæ•´æµ‹è¯•</h2>
        <button onclick="runCompleteTest()" style="background: #28a745; font-size: 16px; padding: 12px 24px;">è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹</button>
        <p style="color: #666; font-size: 14px;">è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æµ‹è¯•æ­¥éª¤ï¼ŒéªŒè¯æ–°é£æ ¼åŒæ­¥åŠŸèƒ½</p>
    </div>

    <div class="test-section">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="debugLog" class="log"></div>
    </div>

    <script src="data.js"></script>
    <script src="genre-manager.js"></script>
    <script>
        let debugLog;
        let testGenreId = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            if (debugLog) {
                debugLog.textContent += logEntry + '\n';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        window.addEventListener('load', async () => {
            debugLog = document.getElementById('debugLog');
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            try {
                await window.genreManager.initialize();
                log('GenreManager åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                log(`GenreManager åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        });

        async function checkCurrentState() {
            log('æ£€æŸ¥å½“å‰çŠ¶æ€...');
            
            let html = '<strong>å½“å‰çŠ¶æ€:</strong><br><br>';
            
            // æ£€æŸ¥ GenreManager
            if (window.genreManager && window.genreManager.isReady()) {
                const genres = window.genreManager.getAllGenres();
                html += `âœ… GenreManager: ${genres.length} ä¸ªé£æ ¼<br>`;
                log(`GenreManager æœ‰ ${genres.length} ä¸ªé£æ ¼`);
                
                genres.forEach(genre => {
                    log(`  - ${genre.name} (${genre.id})`);
                });
            } else {
                html += `âŒ GenreManager: æœªå‡†å¤‡å°±ç»ª<br>`;
                log('GenreManager æœªå‡†å¤‡å°±ç»ª');
            }
            
            // æ£€æŸ¥ localStorage
            const authToken = localStorage.getItem('auth_token');
            if (authToken) {
                html += `âœ… è®¤è¯ä»¤ç‰Œ: å·²å­˜åœ¨<br>`;
                log('è®¤è¯ä»¤ç‰Œå·²å­˜åœ¨');
            } else {
                html += `âŒ è®¤è¯ä»¤ç‰Œ: ä¸å­˜åœ¨<br>`;
                log('è®¤è¯ä»¤ç‰Œä¸å­˜åœ¨');
            }
            
            showResult('currentStateResult', html, 'info');
        }

        async function addTestGenre() {
            const input = document.getElementById('testGenreName');
            const name = input.value.trim();
            
            if (!name) {
                showResult('addGenreResult', 'è¯·è¾“å…¥é£æ ¼åç§°', 'warning');
                return;
            }
            
            if (!window.genreManager || !window.genreManager.isReady()) {
                showResult('addGenreResult', 'GenreManager æœªå‡†å¤‡å°±ç»ª', 'error');
                return;
            }

            try {
                log(`æ·»åŠ æµ‹è¯•é£æ ¼: ${name}`);
                const newGenre = window.genreManager.addGenre(name);
                testGenreId = newGenre.id;
                
                log(`é£æ ¼æ·»åŠ æˆåŠŸ: ${newGenre.name} (${newGenre.id})`);
                
                // æµ‹è¯•æ˜¾ç¤º
                const displayName = window.genreManager.getDisplayName(newGenre.id);
                log(`æ˜¾ç¤ºæµ‹è¯•: getDisplayName("${newGenre.id}") = "${displayName}"`);
                
                let html = `<strong>æ·»åŠ ç»“æœ:</strong><br><br>`;
                html += `âœ… é£æ ¼ID: ${newGenre.id}<br>`;
                html += `âœ… é£æ ¼åç§°: ${newGenre.name}<br>`;
                html += `âœ… æ˜¾ç¤ºæµ‹è¯•: ${displayName}<br>`;
                
                showResult('addGenreResult', html, 'success');
                
            } catch (error) {
                log(`æ·»åŠ é£æ ¼å¤±è´¥: ${error.message}`);
                showResult('addGenreResult', `âŒ æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testServerSync() {
            if (!testGenreId) {
                showResult('syncResult', 'è¯·å…ˆæ·»åŠ æµ‹è¯•é£æ ¼', 'warning');
                return;
            }

            log('å¼€å§‹æµ‹è¯•æœåŠ¡å™¨åŒæ­¥...');

            try {
                // æ¨¡æ‹Ÿç®¡ç†é¡µé¢çš„åŒæ­¥é€»è¾‘
                const authToken = localStorage.getItem('auth_token');
                if (!authToken) {
                    throw new Error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•ç®¡ç†é¡µé¢');
                }

                // è·å–å½“å‰æ‰€æœ‰é£æ ¼
                const allGenres = window.genreManager.getAllGenres();
                log(`å‡†å¤‡åŒæ­¥ ${allGenres.length} ä¸ªé£æ ¼åˆ°æœåŠ¡å™¨`);

                // æ„å»ºåŒæ­¥æ•°æ®
                const dataToSync = {
                    songs: [], // ç®€åŒ–æµ‹è¯•ï¼Œåªä¼ ç©ºæ•°ç»„
                    profile: {},
                    customGenres: allGenres
                };

                log('å‘é€åŒæ­¥è¯·æ±‚åˆ°æœåŠ¡å™¨...');
                const response = await fetch('/api/update-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(dataToSync, null, 2)
                });

                const result = await response.json();
                log(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(result)}`);

                if (result.success) {
                    showResult('syncResult', 'âœ… æœåŠ¡å™¨åŒæ­¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±è´¥');
                }

            } catch (error) {
                log(`æœåŠ¡å™¨åŒæ­¥å¤±è´¥: ${error.message}`);
                showResult('syncResult', `âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifyServerData() {
            log('éªŒè¯æœåŠ¡å™¨æ•°æ®...');

            try {
                // é‡æ–°åŠ è½½ data.js æ–‡ä»¶
                const timestamp = Date.now();
                const response = await fetch(`/data.js?t=${timestamp}`);
                const text = await response.text();
                
                log('ä»æœåŠ¡å™¨è·å–åˆ°çš„ data.js å†…å®¹é•¿åº¦: ' + text.length);

                // è§£æå†…å®¹
                const match = text.match(/window\.officialData\s*=\s*({[\s\S]*?});/);
                if (match) {
                    const dataStr = match[1];
                    const data = eval('(' + dataStr + ')');
                    
                    if (data.customGenres && Array.isArray(data.customGenres)) {
                        log(`æœåŠ¡å™¨ data.js ä¸­æœ‰ ${data.customGenres.length} ä¸ªé£æ ¼`);
                        
                        let html = `<strong>æœåŠ¡å™¨æ•°æ®éªŒè¯:</strong><br><br>`;
                        html += `âœ… customGenres æ•°ç»„å­˜åœ¨<br>`;
                        html += `âœ… é£æ ¼æ•°é‡: ${data.customGenres.length}<br><br>`;
                        
                        // æ£€æŸ¥æµ‹è¯•é£æ ¼æ˜¯å¦å­˜åœ¨
                        const testGenre = data.customGenres.find(g => g.id === testGenreId);
                        if (testGenre) {
                            html += `âœ… æµ‹è¯•é£æ ¼å·²åŒæ­¥: ${testGenre.name} (${testGenre.id})<br>`;
                            log(`æµ‹è¯•é£æ ¼å·²åŒæ­¥åˆ°æœåŠ¡å™¨: ${testGenre.name}`);
                        } else {
                            html += `âŒ æµ‹è¯•é£æ ¼æœªæ‰¾åˆ°<br>`;
                            log('æµ‹è¯•é£æ ¼æœªåœ¨æœåŠ¡å™¨æ•°æ®ä¸­æ‰¾åˆ°');
                        }
                        
                        showResult('verifyResult', html, testGenre ? 'success' : 'warning');
                    } else {
                        throw new Error('æœåŠ¡å™¨æ•°æ®ä¸­æ²¡æœ‰ customGenres æ•°ç»„');
                    }
                } else {
                    throw new Error('æ— æ³•è§£ææœåŠ¡å™¨æ•°æ®æ ¼å¼');
                }

            } catch (error) {
                log(`éªŒè¯æœåŠ¡å™¨æ•°æ®å¤±è´¥: ${error.message}`);
                showResult('verifyResult', `âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMainPageRefresh() {
            log('æµ‹è¯•ä¸»é¡µé¢æ•°æ®åˆ·æ–°...');

            try {
                // å¼ºåˆ¶åˆ·æ–° GenreManager
                await window.genreManager.refresh();
                log('GenreManager åˆ·æ–°å®Œæˆ');

                // æ£€æŸ¥æµ‹è¯•é£æ ¼æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
                if (testGenreId) {
                    const displayName = window.genreManager.getDisplayName(testGenreId);
                    const isCorrect = !displayName.startsWith('custom_');

                    let html = `<strong>ä¸»é¡µé¢åˆ·æ–°æµ‹è¯•:</strong><br><br>`;
                    html += `ğŸ” æµ‹è¯•é£æ ¼ID: ${testGenreId}<br>`;
                    html += `ğŸ“ æ˜¾ç¤ºåç§°: "${displayName}"<br>`;
                    html += `${isCorrect ? 'âœ…' : 'âŒ'} æ˜¾ç¤ºçŠ¶æ€: ${isCorrect ? 'æ­£ç¡®' : 'æ˜¾ç¤ºä¸º custom_id'}<br>`;

                    showResult('refreshResult', html, isCorrect ? 'success' : 'error');
                    log(`åˆ·æ–°åæ˜¾ç¤ºæµ‹è¯•: "${displayName}" ${isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯'}`);
                } else {
                    showResult('refreshResult', 'è¯·å…ˆæ·»åŠ æµ‹è¯•é£æ ¼', 'warning');
                }

            } catch (error) {
                log(`ä¸»é¡µé¢åˆ·æ–°æµ‹è¯•å¤±è´¥: ${error.message}`);
                showResult('refreshResult', `âŒ åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            log('å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...');

            try {
                // 1. æ£€æŸ¥å½“å‰çŠ¶æ€
                await checkCurrentState();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 2. æ·»åŠ æµ‹è¯•é£æ ¼
                document.getElementById('testGenreName').value = 'å®Œæ•´æµ‹è¯•é£æ ¼_' + Date.now();
                await addTestGenre();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 3. æµ‹è¯•æœåŠ¡å™¨åŒæ­¥
                await testServerSync();
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 4. éªŒè¯æœåŠ¡å™¨æ•°æ®
                await verifyServerData();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 5. æµ‹è¯•ä¸»é¡µé¢åˆ·æ–°
                await testMainPageRefresh();

                log('å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ');

            } catch (error) {
                log(`å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        function clearLog() {
            if (debugLog) {
                debugLog.textContent = '';
            }
        }
    </script>
</body>
</html>
