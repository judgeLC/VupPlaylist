<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试同步流程</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>🔄 测试同步流程</h1>
    
    <div class="test-section">
        <h2>1. 检查当前状态</h2>
        <button onclick="checkCurrentState()">检查当前状态</button>
        <div id="currentStateResult"></div>
    </div>

    <div class="test-section">
        <h2>2. 添加测试风格</h2>
        <input type="text" id="testGenreName" placeholder="输入测试风格名称" value="测试同步风格" />
        <button onclick="addTestGenre()">添加测试风格</button>
        <div id="addGenreResult"></div>
    </div>

    <div class="test-section">
        <h2>3. 测试服务器同步</h2>
        <button onclick="testServerSync()">测试服务器同步</button>
        <div id="syncResult"></div>
    </div>

    <div class="test-section">
        <h2>4. 验证服务器数据</h2>
        <button onclick="verifyServerData()">验证服务器数据</button>
        <div id="verifyResult"></div>
    </div>

    <div class="test-section">
        <h2>5. 测试主页面刷新</h2>
        <button onclick="testMainPageRefresh()">测试主页面刷新</button>
        <div id="refreshResult"></div>
    </div>

    <div class="test-section">
        <h2>🚀 完整测试</h2>
        <button onclick="runCompleteTest()" style="background: #28a745; font-size: 16px; padding: 12px 24px;">运行完整测试流程</button>
        <p style="color: #666; font-size: 14px;">自动执行所有测试步骤，验证新风格同步功能</p>
    </div>

    <div class="test-section">
        <h2>调试日志</h2>
        <button onclick="clearLog()">清空日志</button>
        <div id="debugLog" class="log"></div>
    </div>

    <script src="data.js"></script>
    <script src="genre-manager.js"></script>
    <script>
        let debugLog;
        let testGenreId = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            if (debugLog) {
                debugLog.textContent += logEntry + '\n';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        window.addEventListener('load', async () => {
            debugLog = document.getElementById('debugLog');
            log('页面加载完成，开始初始化...');
            
            try {
                await window.genreManager.initialize();
                log('GenreManager 初始化完成');
            } catch (error) {
                log(`GenreManager 初始化失败: ${error.message}`);
            }
        });

        async function checkCurrentState() {
            log('检查当前状态...');
            
            let html = '<strong>当前状态:</strong><br><br>';
            
            // 检查 GenreManager
            if (window.genreManager && window.genreManager.isReady()) {
                const genres = window.genreManager.getAllGenres();
                html += `✅ GenreManager: ${genres.length} 个风格<br>`;
                log(`GenreManager 有 ${genres.length} 个风格`);
                
                genres.forEach(genre => {
                    log(`  - ${genre.name} (${genre.id})`);
                });
            } else {
                html += `❌ GenreManager: 未准备就绪<br>`;
                log('GenreManager 未准备就绪');
            }
            
            // 检查 localStorage
            const authToken = localStorage.getItem('auth_token');
            if (authToken) {
                html += `✅ 认证令牌: 已存在<br>`;
                log('认证令牌已存在');
            } else {
                html += `❌ 认证令牌: 不存在<br>`;
                log('认证令牌不存在');
            }
            
            showResult('currentStateResult', html, 'info');
        }

        async function addTestGenre() {
            const input = document.getElementById('testGenreName');
            const name = input.value.trim();
            
            if (!name) {
                showResult('addGenreResult', '请输入风格名称', 'warning');
                return;
            }
            
            if (!window.genreManager || !window.genreManager.isReady()) {
                showResult('addGenreResult', 'GenreManager 未准备就绪', 'error');
                return;
            }

            try {
                log(`添加测试风格: ${name}`);
                const newGenre = window.genreManager.addGenre(name);
                testGenreId = newGenre.id;
                
                log(`风格添加成功: ${newGenre.name} (${newGenre.id})`);
                
                // 测试显示
                const displayName = window.genreManager.getDisplayName(newGenre.id);
                log(`显示测试: getDisplayName("${newGenre.id}") = "${displayName}"`);
                
                let html = `<strong>添加结果:</strong><br><br>`;
                html += `✅ 风格ID: ${newGenre.id}<br>`;
                html += `✅ 风格名称: ${newGenre.name}<br>`;
                html += `✅ 显示测试: ${displayName}<br>`;
                
                showResult('addGenreResult', html, 'success');
                
            } catch (error) {
                log(`添加风格失败: ${error.message}`);
                showResult('addGenreResult', `❌ 添加失败: ${error.message}`, 'error');
            }
        }

        async function testServerSync() {
            if (!testGenreId) {
                showResult('syncResult', '请先添加测试风格', 'warning');
                return;
            }

            log('开始测试服务器同步...');

            try {
                // 模拟管理页面的同步逻辑
                const authToken = localStorage.getItem('auth_token');
                if (!authToken) {
                    throw new Error('未找到认证令牌，请先登录管理页面');
                }

                // 获取当前所有风格
                const allGenres = window.genreManager.getAllGenres();
                log(`准备同步 ${allGenres.length} 个风格到服务器`);

                // 构建同步数据
                const dataToSync = {
                    songs: [], // 简化测试，只传空数组
                    profile: {},
                    customGenres: allGenres
                };

                log('发送同步请求到服务器...');
                const response = await fetch('/api/update-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(dataToSync, null, 2)
                });

                const result = await response.json();
                log(`服务器响应: ${JSON.stringify(result)}`);

                if (result.success) {
                    showResult('syncResult', '✅ 服务器同步成功', 'success');
                } else {
                    throw new Error(result.message || '同步失败');
                }

            } catch (error) {
                log(`服务器同步失败: ${error.message}`);
                showResult('syncResult', `❌ 同步失败: ${error.message}`, 'error');
            }
        }

        async function verifyServerData() {
            log('验证服务器数据...');

            try {
                // 重新加载 data.js 文件
                const timestamp = Date.now();
                const response = await fetch(`/data.js?t=${timestamp}`);
                const text = await response.text();
                
                log('从服务器获取到的 data.js 内容长度: ' + text.length);

                // 解析内容
                const match = text.match(/window\.officialData\s*=\s*({[\s\S]*?});/);
                if (match) {
                    const dataStr = match[1];
                    const data = eval('(' + dataStr + ')');
                    
                    if (data.customGenres && Array.isArray(data.customGenres)) {
                        log(`服务器 data.js 中有 ${data.customGenres.length} 个风格`);
                        
                        let html = `<strong>服务器数据验证:</strong><br><br>`;
                        html += `✅ customGenres 数组存在<br>`;
                        html += `✅ 风格数量: ${data.customGenres.length}<br><br>`;
                        
                        // 检查测试风格是否存在
                        const testGenre = data.customGenres.find(g => g.id === testGenreId);
                        if (testGenre) {
                            html += `✅ 测试风格已同步: ${testGenre.name} (${testGenre.id})<br>`;
                            log(`测试风格已同步到服务器: ${testGenre.name}`);
                        } else {
                            html += `❌ 测试风格未找到<br>`;
                            log('测试风格未在服务器数据中找到');
                        }
                        
                        showResult('verifyResult', html, testGenre ? 'success' : 'warning');
                    } else {
                        throw new Error('服务器数据中没有 customGenres 数组');
                    }
                } else {
                    throw new Error('无法解析服务器数据格式');
                }

            } catch (error) {
                log(`验证服务器数据失败: ${error.message}`);
                showResult('verifyResult', `❌ 验证失败: ${error.message}`, 'error');
            }
        }

        async function testMainPageRefresh() {
            log('测试主页面数据刷新...');

            try {
                // 强制刷新 GenreManager
                await window.genreManager.refresh();
                log('GenreManager 刷新完成');

                // 检查测试风格是否正确显示
                if (testGenreId) {
                    const displayName = window.genreManager.getDisplayName(testGenreId);
                    const isCorrect = !displayName.startsWith('custom_');

                    let html = `<strong>主页面刷新测试:</strong><br><br>`;
                    html += `🔍 测试风格ID: ${testGenreId}<br>`;
                    html += `📝 显示名称: "${displayName}"<br>`;
                    html += `${isCorrect ? '✅' : '❌'} 显示状态: ${isCorrect ? '正确' : '显示为 custom_id'}<br>`;

                    showResult('refreshResult', html, isCorrect ? 'success' : 'error');
                    log(`刷新后显示测试: "${displayName}" ${isCorrect ? '正确' : '错误'}`);
                } else {
                    showResult('refreshResult', '请先添加测试风格', 'warning');
                }

            } catch (error) {
                log(`主页面刷新测试失败: ${error.message}`);
                showResult('refreshResult', `❌ 刷新失败: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            log('开始完整测试流程...');

            try {
                // 1. 检查当前状态
                await checkCurrentState();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 2. 添加测试风格
                document.getElementById('testGenreName').value = '完整测试风格_' + Date.now();
                await addTestGenre();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 3. 测试服务器同步
                await testServerSync();
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 4. 验证服务器数据
                await verifyServerData();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 5. 测试主页面刷新
                await testMainPageRefresh();

                log('完整测试流程完成');

            } catch (error) {
                log(`完整测试失败: ${error.message}`);
            }
        }

        function clearLog() {
            if (debugLog) {
                debugLog.textContent = '';
            }
        }
    </script>
</body>
</html>
