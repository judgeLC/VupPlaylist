<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>脚本加载调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔍 脚本加载调试页面</h1>
    
    <div class="debug-section">
        <h2>脚本加载状态检查</h2>
        <div id="scriptStatus"></div>
    </div>

    <div class="debug-section">
        <h2>API客户端检查</h2>
        <div id="apiClientStatus"></div>
    </div>

    <div class="debug-section">
        <h2>管理员类检查</h2>
        <div id="adminStatus"></div>
    </div>

    <div class="debug-section">
        <h2>手动测试</h2>
        <button class="test-button" onclick="testApiClient()">测试API客户端</button>
        <button class="test-button" onclick="testSync()">测试同步功能</button>
        <button class="test-button" onclick="clearCache()">清除缓存并刷新</button>
        <div id="testResults"></div>
    </div>

    <div class="debug-section">
        <h2>浏览器信息</h2>
        <div id="browserInfo"></div>
    </div>

    <!-- 按照admin.html的顺序加载脚本 -->
    <script src="data.js"></script>
    <script src="api-client.js?v=1.2"></script>
    <script src="auth.js?v=1.2"></script>
    
    <script>
        function checkScriptLoading() {
            const statusDiv = document.getElementById('scriptStatus');
            let html = '<h3>脚本加载状态:</h3>';
            
            // 检查data.js
            html += `<p>data.js: ${typeof window.data !== 'undefined' ? '<span class="success">✅ 已加载</span>' : '<span class="error">❌ 未加载</span>'}</p>`;
            
            // 检查api-client.js
            html += `<p>api-client.js: ${typeof apiClient !== 'undefined' ? '<span class="success">✅ 已加载</span>' : '<span class="error">❌ 未加载</span>'}</p>`;
            
            // 检查auth.js
            html += `<p>auth.js: ${typeof AuthManager !== 'undefined' ? '<span class="success">✅ 已加载</span>' : '<span class="error">❌ 未加载</span>'}</p>`;
            
            statusDiv.innerHTML = html;
        }

        function checkApiClient() {
            const statusDiv = document.getElementById('apiClientStatus');
            let html = '<h3>API客户端详细信息:</h3>';
            
            if (typeof apiClient !== 'undefined') {
                html += '<p><span class="success">✅ apiClient 对象存在</span></p>';
                html += `<p>类型: ${typeof apiClient}</p>`;
                html += `<p>构造函数: ${apiClient.constructor.name}</p>`;
                
                // 列出可用方法
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(apiClient))
                    .filter(name => name !== 'constructor' && typeof apiClient[name] === 'function');
                html += `<p>可用方法 (${methods.length}个):</p>`;
                html += '<pre>' + methods.join(', ') + '</pre>';
                
                // 检查关键方法
                const keyMethods = ['syncData', 'get', 'post', 'put', 'delete'];
                html += '<p>关键方法检查:</p>';
                keyMethods.forEach(method => {
                    const exists = typeof apiClient[method] === 'function';
                    html += `<p>  ${method}: ${exists ? '<span class="success">✅ 存在</span>' : '<span class="error">❌ 不存在</span>'}</p>`;
                });
            } else {
                html += '<p><span class="error">❌ apiClient 对象不存在</span></p>';
                html += '<p>可能的原因:</p>';
                html += '<ul>';
                html += '<li>api-client.js 文件未加载</li>';
                html += '<li>文件路径错误</li>';
                html += '<li>JavaScript 语法错误</li>';
                html += '<li>浏览器缓存问题</li>';
                html += '</ul>';
            }
            
            statusDiv.innerHTML = html;
        }

        function checkAdminManager() {
            const statusDiv = document.getElementById('adminStatus');
            let html = '<h3>管理员类信息:</h3>';
            
            html += `<p>AdminManager 类: ${typeof AdminManager !== 'undefined' ? '<span class="success">✅ 已定义</span>' : '<span class="error">❌ 未定义</span>'}</p>`;
            
            // 检查全局admin实例
            html += `<p>全局 admin 实例: ${typeof window.admin !== 'undefined' ? '<span class="success">✅ 存在</span>' : '<span class="warning">⚠️ 不存在</span>'}</p>`;
            
            statusDiv.innerHTML = html;
        }

        function showBrowserInfo() {
            const infoDiv = document.getElementById('browserInfo');
            let html = '<h3>浏览器环境信息:</h3>';
            
            html += `<p>用户代理: ${navigator.userAgent}</p>`;
            html += `<p>当前URL: ${window.location.href}</p>`;
            html += `<p>协议: ${window.location.protocol}</p>`;
            html += `<p>主机: ${window.location.host}</p>`;
            html += `<p>JavaScript 启用: <span class="success">✅ 是</span></p>`;
            html += `<p>本地存储支持: ${typeof Storage !== 'undefined' ? '<span class="success">✅ 支持</span>' : '<span class="error">❌ 不支持</span>'}</p>`;
            html += `<p>Fetch API 支持: ${typeof fetch !== 'undefined' ? '<span class="success">✅ 支持</span>' : '<span class="error">❌ 不支持</span>'}</p>`;
            
            infoDiv.innerHTML = html;
        }

        function testApiClient() {
            const resultsDiv = document.getElementById('testResults');
            
            if (typeof apiClient === 'undefined') {
                resultsDiv.innerHTML = '<p><span class="error">❌ 无法测试：apiClient 未定义</span></p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p><span class="info">🔄 正在测试API客户端...</span></p>';
            
            // 测试简单的GET请求
            apiClient.get('/settings')
                .then(result => {
                    resultsDiv.innerHTML = `
                        <p><span class="success">✅ API客户端测试成功</span></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `
                        <p><span class="error">❌ API客户端测试失败</span></p>
                        <p>错误: ${error.message}</p>
                    `;
                });
        }

        function testSync() {
            const resultsDiv = document.getElementById('testResults');
            
            if (typeof apiClient === 'undefined') {
                resultsDiv.innerHTML = '<p><span class="error">❌ 无法测试：apiClient 未定义</span></p>';
                return;
            }
            
            // 模拟登录
            const session = {
                token: 'test-token-' + Date.now(),
                createdAt: Date.now(),
                expiresAt: Date.now() + (24 * 60 * 60 * 1000),
                lastActivity: Date.now()
            };
            localStorage.setItem('vtuber_admin_session', JSON.stringify(session));
            localStorage.setItem('auth_token', session.token);
            
            resultsDiv.innerHTML = '<p><span class="info">🔄 正在测试同步功能...</span></p>';
            
            const testData = {
                profile: { vtuberName: '测试主播', vtuberDesc: '调试测试' },
                songs: [{ id: 'debug1', title: '调试歌曲', artist: '调试歌手' }]
            };
            
            apiClient.syncData(testData)
                .then(result => {
                    resultsDiv.innerHTML = `
                        <p><span class="success">✅ 同步功能测试成功</span></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `
                        <p><span class="error">❌ 同步功能测试失败</span></p>
                        <p>错误: ${error.message}</p>
                    `;
                });
        }

        function clearCache() {
            // 清除相关的localStorage
            const keys = ['vtuber_admin_session', 'auth_token', 'vtuber_theme', 'vtuber_profile', 'vtuber_songs'];
            keys.forEach(key => localStorage.removeItem(key));
            
            // 强制刷新页面，绕过缓存
            window.location.reload(true);
        }

        // 页面加载完成后执行检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkScriptLoading();
                checkApiClient();
                checkAdminManager();
                showBrowserInfo();
            }, 100);
        });

        // 监听脚本加载错误
        window.addEventListener('error', function(e) {
            console.error('脚本加载错误:', e);
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<p><span class="error">❌ 脚本错误: ${e.filename} (行 ${e.lineno}): ${e.message}</span></p>`;
            document.body.appendChild(errorDiv);
        });
    </script>
</body>
</html>
