<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„šæœ¬åŠ è½½è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è„šæœ¬åŠ è½½è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h2>è„šæœ¬åŠ è½½çŠ¶æ€æ£€æŸ¥</h2>
        <div id="scriptStatus"></div>
    </div>

    <div class="debug-section">
        <h2>APIå®¢æˆ·ç«¯æ£€æŸ¥</h2>
        <div id="apiClientStatus"></div>
    </div>

    <div class="debug-section">
        <h2>ç®¡ç†å‘˜ç±»æ£€æŸ¥</h2>
        <div id="adminStatus"></div>
    </div>

    <div class="debug-section">
        <h2>æ‰‹åŠ¨æµ‹è¯•</h2>
        <button class="test-button" onclick="testApiClient()">æµ‹è¯•APIå®¢æˆ·ç«¯</button>
        <button class="test-button" onclick="testSync()">æµ‹è¯•åŒæ­¥åŠŸèƒ½</button>
        <button class="test-button" onclick="clearCache()">æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
        <div id="testResults"></div>
    </div>

    <div class="debug-section">
        <h2>æµè§ˆå™¨ä¿¡æ¯</h2>
        <div id="browserInfo"></div>
    </div>

    <!-- æŒ‰ç…§admin.htmlçš„é¡ºåºåŠ è½½è„šæœ¬ -->
    <script src="data.js"></script>
    <script src="api-client.js?v=1.2"></script>
    <script src="auth.js?v=1.2"></script>
    
    <script>
        function checkScriptLoading() {
            const statusDiv = document.getElementById('scriptStatus');
            let html = '<h3>è„šæœ¬åŠ è½½çŠ¶æ€:</h3>';
            
            // æ£€æŸ¥data.js
            html += `<p>data.js: ${typeof window.data !== 'undefined' ? '<span class="success">âœ… å·²åŠ è½½</span>' : '<span class="error">âŒ æœªåŠ è½½</span>'}</p>`;
            
            // æ£€æŸ¥api-client.js
            html += `<p>api-client.js: ${typeof apiClient !== 'undefined' ? '<span class="success">âœ… å·²åŠ è½½</span>' : '<span class="error">âŒ æœªåŠ è½½</span>'}</p>`;
            
            // æ£€æŸ¥auth.js
            html += `<p>auth.js: ${typeof AuthManager !== 'undefined' ? '<span class="success">âœ… å·²åŠ è½½</span>' : '<span class="error">âŒ æœªåŠ è½½</span>'}</p>`;
            
            statusDiv.innerHTML = html;
        }

        function checkApiClient() {
            const statusDiv = document.getElementById('apiClientStatus');
            let html = '<h3>APIå®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯:</h3>';
            
            if (typeof apiClient !== 'undefined') {
                html += '<p><span class="success">âœ… apiClient å¯¹è±¡å­˜åœ¨</span></p>';
                html += `<p>ç±»å‹: ${typeof apiClient}</p>`;
                html += `<p>æ„é€ å‡½æ•°: ${apiClient.constructor.name}</p>`;
                
                // åˆ—å‡ºå¯ç”¨æ–¹æ³•
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(apiClient))
                    .filter(name => name !== 'constructor' && typeof apiClient[name] === 'function');
                html += `<p>å¯ç”¨æ–¹æ³• (${methods.length}ä¸ª):</p>`;
                html += '<pre>' + methods.join(', ') + '</pre>';
                
                // æ£€æŸ¥å…³é”®æ–¹æ³•
                const keyMethods = ['syncData', 'get', 'post', 'put', 'delete'];
                html += '<p>å…³é”®æ–¹æ³•æ£€æŸ¥:</p>';
                keyMethods.forEach(method => {
                    const exists = typeof apiClient[method] === 'function';
                    html += `<p>  ${method}: ${exists ? '<span class="success">âœ… å­˜åœ¨</span>' : '<span class="error">âŒ ä¸å­˜åœ¨</span>'}</p>`;
                });
            } else {
                html += '<p><span class="error">âŒ apiClient å¯¹è±¡ä¸å­˜åœ¨</span></p>';
                html += '<p>å¯èƒ½çš„åŸå› :</p>';
                html += '<ul>';
                html += '<li>api-client.js æ–‡ä»¶æœªåŠ è½½</li>';
                html += '<li>æ–‡ä»¶è·¯å¾„é”™è¯¯</li>';
                html += '<li>JavaScript è¯­æ³•é”™è¯¯</li>';
                html += '<li>æµè§ˆå™¨ç¼“å­˜é—®é¢˜</li>';
                html += '</ul>';
            }
            
            statusDiv.innerHTML = html;
        }

        function checkAdminManager() {
            const statusDiv = document.getElementById('adminStatus');
            let html = '<h3>ç®¡ç†å‘˜ç±»ä¿¡æ¯:</h3>';
            
            html += `<p>AdminManager ç±»: ${typeof AdminManager !== 'undefined' ? '<span class="success">âœ… å·²å®šä¹‰</span>' : '<span class="error">âŒ æœªå®šä¹‰</span>'}</p>`;
            
            // æ£€æŸ¥å…¨å±€adminå®ä¾‹
            html += `<p>å…¨å±€ admin å®ä¾‹: ${typeof window.admin !== 'undefined' ? '<span class="success">âœ… å­˜åœ¨</span>' : '<span class="warning">âš ï¸ ä¸å­˜åœ¨</span>'}</p>`;
            
            statusDiv.innerHTML = html;
        }

        function showBrowserInfo() {
            const infoDiv = document.getElementById('browserInfo');
            let html = '<h3>æµè§ˆå™¨ç¯å¢ƒä¿¡æ¯:</h3>';
            
            html += `<p>ç”¨æˆ·ä»£ç†: ${navigator.userAgent}</p>`;
            html += `<p>å½“å‰URL: ${window.location.href}</p>`;
            html += `<p>åè®®: ${window.location.protocol}</p>`;
            html += `<p>ä¸»æœº: ${window.location.host}</p>`;
            html += `<p>JavaScript å¯ç”¨: <span class="success">âœ… æ˜¯</span></p>`;
            html += `<p>æœ¬åœ°å­˜å‚¨æ”¯æŒ: ${typeof Storage !== 'undefined' ? '<span class="success">âœ… æ”¯æŒ</span>' : '<span class="error">âŒ ä¸æ”¯æŒ</span>'}</p>`;
            html += `<p>Fetch API æ”¯æŒ: ${typeof fetch !== 'undefined' ? '<span class="success">âœ… æ”¯æŒ</span>' : '<span class="error">âŒ ä¸æ”¯æŒ</span>'}</p>`;
            
            infoDiv.innerHTML = html;
        }

        function testApiClient() {
            const resultsDiv = document.getElementById('testResults');
            
            if (typeof apiClient === 'undefined') {
                resultsDiv.innerHTML = '<p><span class="error">âŒ æ— æ³•æµ‹è¯•ï¼šapiClient æœªå®šä¹‰</span></p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p><span class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIå®¢æˆ·ç«¯...</span></p>';
            
            // æµ‹è¯•ç®€å•çš„GETè¯·æ±‚
            apiClient.get('/settings')
                .then(result => {
                    resultsDiv.innerHTML = `
                        <p><span class="success">âœ… APIå®¢æˆ·ç«¯æµ‹è¯•æˆåŠŸ</span></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `
                        <p><span class="error">âŒ APIå®¢æˆ·ç«¯æµ‹è¯•å¤±è´¥</span></p>
                        <p>é”™è¯¯: ${error.message}</p>
                    `;
                });
        }

        function testSync() {
            const resultsDiv = document.getElementById('testResults');
            
            if (typeof apiClient === 'undefined') {
                resultsDiv.innerHTML = '<p><span class="error">âŒ æ— æ³•æµ‹è¯•ï¼šapiClient æœªå®šä¹‰</span></p>';
                return;
            }
            
            // æ¨¡æ‹Ÿç™»å½•
            const session = {
                token: 'test-token-' + Date.now(),
                createdAt: Date.now(),
                expiresAt: Date.now() + (24 * 60 * 60 * 1000),
                lastActivity: Date.now()
            };
            localStorage.setItem('vtuber_admin_session', JSON.stringify(session));
            localStorage.setItem('auth_token', session.token);
            
            resultsDiv.innerHTML = '<p><span class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•åŒæ­¥åŠŸèƒ½...</span></p>';
            
            const testData = {
                profile: { vtuberName: 'æµ‹è¯•ä¸»æ’­', vtuberDesc: 'è°ƒè¯•æµ‹è¯•' },
                songs: [{ id: 'debug1', title: 'è°ƒè¯•æ­Œæ›²', artist: 'è°ƒè¯•æ­Œæ‰‹' }]
            };
            
            apiClient.syncData(testData)
                .then(result => {
                    resultsDiv.innerHTML = `
                        <p><span class="success">âœ… åŒæ­¥åŠŸèƒ½æµ‹è¯•æˆåŠŸ</span></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `
                        <p><span class="error">âŒ åŒæ­¥åŠŸèƒ½æµ‹è¯•å¤±è´¥</span></p>
                        <p>é”™è¯¯: ${error.message}</p>
                    `;
                });
        }

        function clearCache() {
            // æ¸…é™¤ç›¸å…³çš„localStorage
            const keys = ['vtuber_admin_session', 'auth_token', 'vtuber_theme', 'vtuber_profile', 'vtuber_songs'];
            keys.forEach(key => localStorage.removeItem(key));
            
            // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œç»•è¿‡ç¼“å­˜
            window.location.reload(true);
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkScriptLoading();
                checkApiClient();
                checkAdminManager();
                showBrowserInfo();
            }, 100);
        });

        // ç›‘å¬è„šæœ¬åŠ è½½é”™è¯¯
        window.addEventListener('error', function(e) {
            console.error('è„šæœ¬åŠ è½½é”™è¯¯:', e);
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<p><span class="error">âŒ è„šæœ¬é”™è¯¯: ${e.filename} (è¡Œ ${e.lineno}): ${e.message}</span></p>`;
            document.body.appendChild(errorDiv);
        });
    </script>
</body>
</html>
