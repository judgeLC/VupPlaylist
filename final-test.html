<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最终风格测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .song-item { margin: 5px 0; padding: 8px; background: #f9f9f9; }
        .genre-display { color: #007bff; font-weight: bold; }
        pre { background: #f0f0f0; padding: 10px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>风格显示最终测试</h1>
    
    <div class="test-section">
        <h2>数据加载状态</h2>
        <div id="dataStatus">正在检查...</div>
    </div>

    <div class="test-section">
        <h2>风格映射测试</h2>
        <div id="genreMapping">正在测试...</div>
    </div>

    <div class="test-section">
        <h2>实际歌曲风格显示</h2>
        <div id="songGenres">正在加载...</div>
    </div>

    <script src="data.js"></script>
    <script>
        let testResults = {
            dataLoaded: false,
            genreMappingWorking: false,
            songsDisplayCorrectly: false
        };

        function checkDataStatus() {
            const statusDiv = document.getElementById('dataStatus');
            let html = '';

            if (window.officialData) {
                html += '<p class="success">✓ window.officialData 已加载</p>';
                testResults.dataLoaded = true;
                
                if (window.officialData.songs) {
                    html += `<p class="success">✓ 歌曲数据已加载 (${window.officialData.songs.length} 首)</p>`;
                } else {
                    html += '<p class="error">✗ 歌曲数据未找到</p>';
                }

                if (window.officialData.customGenres) {
                    html += `<p class="success">✓ 自定义风格数据已加载 (${window.officialData.customGenres.length} 个)</p>`;
                    html += '<details><summary>查看风格数据</summary><pre>' + 
                           JSON.stringify(window.officialData.customGenres, null, 2) + '</pre></details>';
                } else {
                    html += '<p class="error">✗ 自定义风格数据未找到</p>';
                }
            } else {
                html += '<p class="error">✗ window.officialData 未加载</p>';
            }

            statusDiv.innerHTML = html;
        }

        function testGenreMapping() {
            const mappingDiv = document.getElementById('genreMapping');
            let html = '';
            let successCount = 0;
            let totalCount = 0;

            if (!window.officialData || !window.officialData.customGenres) {
                html += '<p class="error">无法测试：数据未加载</p>';
                mappingDiv.innerHTML = html;
                return;
            }

            // 测试所有自定义风格ID
            const testIds = window.officialData.customGenres.map(g => g.id);
            
            html += '<h3>风格ID映射测试:</h3>';
            testIds.forEach(genreId => {
                const matchedGenre = window.officialData.customGenres.find(g => g.id === genreId);
                const displayName = matchedGenre ? matchedGenre.name : genreId;
                const isCorrect = displayName !== genreId;
                
                totalCount++;
                if (isCorrect) successCount++;
                
                html += `<div class="${isCorrect ? 'success' : 'error'}">
                    ${isCorrect ? '✓' : '✗'} ${genreId} → ${displayName}
                </div>`;
            });

            html += `<p><strong>映射成功率: ${successCount}/${totalCount} (${Math.round(successCount/totalCount*100)}%)</strong></p>`;
            
            testResults.genreMappingWorking = successCount === totalCount;
            mappingDiv.innerHTML = html;
        }

        function testSongGenreDisplay() {
            const songsDiv = document.getElementById('songGenres');
            let html = '';
            let correctCount = 0;
            let totalCount = 0;

            if (!window.officialData || !window.officialData.songs || !window.officialData.customGenres) {
                html += '<p class="error">无法测试：数据未加载</p>';
                songsDiv.innerHTML = html;
                return;
            }

            // 测试前20首歌的风格显示
            const testSongs = window.officialData.songs.slice(0, 20);
            
            html += '<h3>歌曲风格显示测试 (前20首):</h3>';
            testSongs.forEach((song, index) => {
                const matchedGenre = window.officialData.customGenres.find(g => g.id === song.genre);
                const displayName = matchedGenre ? matchedGenre.name : song.genre;
                const isCorrect = displayName !== song.genre;
                
                totalCount++;
                if (isCorrect) correctCount++;
                
                html += `<div class="song-item">
                    <strong>${index + 1}. ${song.title}</strong><br>
                    风格: <span class="genre-display ${isCorrect ? 'success' : 'error'}">${displayName}</span>
                    ${isCorrect ? ' ✓' : ' ✗'}
                </div>`;
            });

            html += `<p><strong>显示正确率: ${correctCount}/${totalCount} (${Math.round(correctCount/totalCount*100)}%)</strong></p>`;
            
            testResults.songsDisplayCorrectly = correctCount === totalCount;
            songsDiv.innerHTML = html;
        }

        function runAllTests() {
            console.log('开始运行所有测试...');
            checkDataStatus();
            testGenreMapping();
            testSongGenreDisplay();
            
            // 显示总体结果
            setTimeout(() => {
                const allPassed = testResults.dataLoaded && testResults.genreMappingWorking && testResults.songsDisplayCorrectly;
                console.log('测试结果:', testResults);
                
                if (allPassed) {
                    console.log('🎉 所有测试通过！风格显示问题已修复！');
                } else {
                    console.log('❌ 部分测试失败，需要进一步调试');
                }
            }, 500);
        }

        // 等待数据加载完成后运行测试
        function waitForDataAndTest() {
            if (window.officialData) {
                runAllTests();
            } else {
                console.log('等待数据加载...');
                setTimeout(waitForDataAndTest, 100);
            }
        }

        document.addEventListener('DOMContentLoaded', waitForDataAndTest);
    </script>

    <div style="margin-top: 20px;">
        <button onclick="runAllTests()">重新运行测试</button>
        <button onclick="location.reload()">刷新页面</button>
    </div>
</body>
</html>
