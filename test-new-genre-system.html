<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°é£æ ¼ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        .add-genre-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        .add-genre-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .genre-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .genre-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .genre-item.builtin { background: #cce5ff; }
        .delete-btn {
            background: #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }
        .delete-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ–°é£æ ¼ç®¡ç†ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h3>
        <button onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“‹ é£æ ¼æ•°æ®åŠ è½½æµ‹è¯•</h3>
        <button onclick="testGenreLoading()">åŠ è½½é£æ ¼æ•°æ®</button>
        <div id="loading-result" class="result"></div>
        <div id="genre-display" class="genre-list"></div>
    </div>
    
    <div class="test-section">
        <h3>â• æ·»åŠ é£æ ¼æµ‹è¯•</h3>
        <div class="add-genre-form">
            <input type="text" id="newGenreName" placeholder="è¾“å…¥æ–°é£æ ¼åç§°" />
            <button onclick="testAddGenre()">æ·»åŠ é£æ ¼</button>
        </div>
        <div id="add-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”„ å‰ç«¯æ˜¾ç¤ºæµ‹è¯•</h3>
        <button onclick="testFrontendDisplay()">æµ‹è¯•å‰ç«¯æ˜¾ç¤º</button>
        <div id="display-result" class="result"></div>
        <div id="display-demo"></div>
    </div>

    <script src="simple-genre-manager.js"></script>
    <script>
        let authToken = '';
        
        // è·å–è®¤è¯ä»¤ç‰Œ
        async function getAuthToken() {
            if (authToken) return authToken;
            
            // å°è¯•ä»localStorageè·å–
            authToken = localStorage.getItem('auth_token');
            if (!authToken) {
                // å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œæç¤ºç”¨æˆ·
                const token = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜ä»¤ç‰Œï¼ˆä»adminé¡µé¢è·å–ï¼‰:');
                if (token) {
                    authToken = token;
                    localStorage.setItem('auth_token', token);
                }
            }
            return authToken;
        }
        
        async function testAPIConnection() {
            const resultDiv = document.getElementById('api-result');
            try {
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
                
                const response = await fetch('/api/genres');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… APIè¿æ¥æˆåŠŸ\nçŠ¶æ€: ${response.status}\né£æ ¼æ•°é‡: ${result.data.length}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ APIè¿æ¥å¤±è´¥\nçŠ¶æ€: ${response.status}\né”™è¯¯: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¿æ¥é”™è¯¯: ${error.message}`;
            }
        }
        
        async function testGenreLoading() {
            const resultDiv = document.getElementById('loading-result');
            const displayDiv = document.getElementById('genre-display');
            
            try {
                resultDiv.textContent = 'æ­£åœ¨åŠ è½½é£æ ¼æ•°æ®...';
                
                await window.simpleGenreManager.initialize();
                const genres = window.simpleGenreManager.getAllGenres();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… é£æ ¼æ•°æ®åŠ è½½æˆåŠŸ\næ€»æ•°: ${genres.length}`;
                
                // æ˜¾ç¤ºé£æ ¼åˆ—è¡¨
                displayDiv.innerHTML = genres.map(genre => `
                    <div class="genre-item ${genre.builtIn ? 'builtin' : ''}">
                        <span>${genre.name} (${genre.id})</span>
                        ${!genre.builtIn ? `<button class="delete-btn" onclick="testDeleteGenre('${genre.id}')">åˆ é™¤</button>` : '<span>[å†…ç½®]</span>'}
                    </div>
                `).join('');
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testAddGenre() {
            const input = document.getElementById('newGenreName');
            const resultDiv = document.getElementById('add-result');
            const name = input.value.trim();
            
            if (!name) {
                resultDiv.className = 'result warning';
                resultDiv.textContent = 'âš ï¸ è¯·è¾“å…¥é£æ ¼åç§°';
                return;
            }
            
            try {
                resultDiv.textContent = 'æ­£åœ¨æ·»åŠ é£æ ¼...';
                
                const token = await getAuthToken();
                if (!token) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ éœ€è¦ç®¡ç†å‘˜ä»¤ç‰Œ';
                    return;
                }
                
                const response = await fetch('/api/genres', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… é£æ ¼æ·»åŠ æˆåŠŸ\nID: ${result.data.id}\nåç§°: ${result.data.name}`;
                    input.value = '';
                    
                    // é‡æ–°åŠ è½½é£æ ¼åˆ—è¡¨
                    await testGenreLoading();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ æ·»åŠ å¤±è´¥: ${result.message}`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ·»åŠ é”™è¯¯: ${error.message}`;
            }
        }
        
        async function testDeleteGenre(genreId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé£æ ¼å—ï¼Ÿ')) return;
            
            try {
                const token = await getAuthToken();
                if (!token) {
                    alert('éœ€è¦ç®¡ç†å‘˜ä»¤ç‰Œ');
                    return;
                }
                
                const response = await fetch(`/api/genres/${genreId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('é£æ ¼åˆ é™¤æˆåŠŸ');
                    await testGenreLoading();
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                }
                
            } catch (error) {
                alert(`åˆ é™¤é”™è¯¯: ${error.message}`);
            }
        }
        
        async function testFrontendDisplay() {
            const resultDiv = document.getElementById('display-result');
            const demoDiv = document.getElementById('display-demo');
            
            try {
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å‰ç«¯æ˜¾ç¤º...';
                
                await window.simpleGenreManager.initialize();
                const genres = window.simpleGenreManager.getAllGenres();
                
                // æ¨¡æ‹Ÿæ­Œæ›²æ•°æ®
                const mockSongs = [
                    { id: 1, title: 'æµ‹è¯•æ­Œæ›²1', genre: 'pop' },
                    { id: 2, title: 'æµ‹è¯•æ­Œæ›²2', genre: 'rock' },
                    { id: 3, title: 'æµ‹è¯•æ­Œæ›²3', genre: genres.find(g => !g.builtIn)?.id || 'folk' }
                ];
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… å‰ç«¯æ˜¾ç¤ºæµ‹è¯•æˆåŠŸ\nå¯ç”¨é£æ ¼: ${genres.length}ä¸ª`;
                
                // æ˜¾ç¤ºæ¨¡æ‹Ÿçš„æ­Œæ›²åˆ—è¡¨
                demoDiv.innerHTML = `
                    <h4>æ¨¡æ‹Ÿæ­Œæ›²æ˜¾ç¤º:</h4>
                    <div style="background: white; padding: 15px; border-radius: 5px;">
                        ${mockSongs.map(song => `
                            <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                <strong>${song.title}</strong> - 
                                <span style="color: #007bff;">${window.simpleGenreManager.getDisplayName(song.genre)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•APIè¿æ¥
        window.addEventListener('load', () => {
            setTimeout(testAPIConnection, 500);
        });
    </script>
</body>
</html>
